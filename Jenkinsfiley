pipeline {
    agent any

    environment {
        WAR_NAME      = "App02.war"
        APP_NAME      = "App02"
        TOMCAT_HOME   = "C:\\Tomcat 9.0"
        TOMCAT_SERVICE = "Tomcat9"     // üëà Adjust if your Windows service has a different name
        JAVA_HOME     = "C:\\Program Files\\Java\\jdk-17"
        PATH          = "${env.PATH};${env.JAVA_HOME}\\bin"
    }

    tools {
        maven 'apache-maven-3.9.5'
    }

    stages {

        stage('Checkout SCM') {
            steps {
                git branch: 'main',
                    credentialsId: 'Github_username_password',
                    url: 'https://github.com/dylandsilva688/API_Projects.git'
            }
        }

        stage('Build Maven Project') {
            steps {
                bat '''
                    echo ===========================
                    echo Building the WAR file...
                    echo ===========================
                    mvn clean package -DskipTests
                '''
            }
        }

        stage('Deploy to Tomcat (Service)') {
            steps {
                script {
                    try {
                        bat '''
                            echo ===========================
                            echo Stopping Tomcat service...
                            echo ===========================
                            net stop "%TOMCAT_SERVICE%" || echo Tomcat service not running

                            echo ===========================
                            echo Removing old deployment...
                            echo ===========================
                            if exist "%TOMCAT_HOME%\\webapps\\%APP_NAME%.war" del /Q "%TOMCAT_HOME%\\webapps\\%APP_NAME%.war"
                            if exist "%TOMCAT_HOME%\\webapps\\%APP_NAME%" rmdir /S /Q "%TOMCAT_HOME%\\webapps\\%APP_NAME%"

                            echo ===========================
                            echo Copying new WAR file...
                            echo ===========================
                            copy "target\\%WAR_NAME%" "%TOMCAT_HOME%\\webapps\\%WAR_NAME%" /Y

                            if %ERRORLEVEL% NEQ 0 (
                                echo ‚ùå Failed to copy WAR file!
                                exit /b 1
                            )

                            echo ===========================
                            echo Starting Tomcat service...
                            echo ===========================
                            net start "%TOMCAT_SERVICE%"

                            if %ERRORLEVEL% EQU 0 (
                                echo ‚úÖ Deployment completed successfully!
                            ) else (
                                echo ‚ùå Tomcat service failed to start!
                                exit /b 1
                            )
                        '''
                    } catch (err) {
                        echo "‚ùå Deployment failed: ${err}"
                        error("Deployment failed: ${err}")
                    }
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Build and deployment completed successfully.'
        }
        failure {
            echo '‚ùå Build or deployment failed. Check console output for details.'
        }
    }
}














